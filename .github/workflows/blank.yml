name: Build TWRP for OnePlus 13R (giulia)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Git identity
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git repo build-essential bc

    - name: Initialize repo
      run: |
        mkdir -p workspace && cd workspace
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1

    - name: Add local manifest for giulia
      run: |
        cd workspace
        mkdir -p .repo/local_manifests
        cat <<EOF > .repo/local_manifests/giulia.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
            <remote name="github" fetch="https://github.com/" />
            <project path="device/oneplus/giulia" name="your-username/android_device_oneplus_giulia" remote="github" revision="twrp-12.1" />
        </manifest>
        EOF

    - name: Sync repo
      run: |
        cd workspace
        repo sync --force-sync --no-clone-bundle --no-tags -j$(nproc)

    - name: Build TWRP
      run: |
        cd workspace
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        lunch twrp_giulia-eng
        mka recoveryimage

    - name: Upload built image
      uses: actions/upload-artifact@v3
      with:
        name: twrp-output
        path: workspace/out/target/product/giulia/recovery.img
